---
import { db } from "@/lib/database";
import { playlist, track } from "@/lib/schema";
import { and, eq } from "drizzle-orm";
import Table from "./table.svelte";

interface Props {
	playlistId?: string;
}
const { playlistId } = Astro.props;

const user = Astro.locals.user;
if (!user) return new Response(null, { status: 401 });
const tracks = playlistId
	? await db.query.playlist.findMany({
			where: and(eq(playlist.id, playlistId), eq(playlist.owner, user.id)),
		})
	: await db.query.track.findMany({
			where: eq(track.owner, user.id),
		});
if (!tracks) return new Response(null, { status: 500 });

Astro.cookies.set("tracks", String(tracks.length), {
	path: "/",
	sameSite: "lax",
	httpOnly: true,
});
---

<Table client:idle tracks={tracks} />
